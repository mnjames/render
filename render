#! /bin/bash

if [ $# == 0 ]; then
    echo "The 'book' argument is required."
    exit
fi

echo "Pre-processing files"
cd preprocessing
if [ ! books/$1/Interlinear.xml ]; then
  echo "Building the interlinear (this could take a while)."
  lua create-interlinear.lua $1
fi
lua preprocess.lua $@ && cd ..

CHAPTERS=$(ls *.xml)

echo "Rendering PDFs"
for CHAPTER in $CHAPTERS
do
  sile $CHAPTER
  # sile $CHAPTER -d frames
  # sile $CHAPTER -d typesetter
done

if [ ! -d output/$1 ]; then
  mkdir output/$1
fi

echo "Combining PDFs"
PDFS=$(ls *.pdf)
gs -dNOPAUSE -sDEVICE=pdfwrite -sOUTPUTFILE=$1.pdf -dBATCH $PDFS

mv *.xml output/$1
mv *.pdf output/$1